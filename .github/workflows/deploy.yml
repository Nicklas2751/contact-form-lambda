name: Deploy to AWS Lambda

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.14'

    - name: Install dependencies for testing
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run tests
      run: |
        python -m unittest discover

    - name: Prepare deployment package
      if: success()
      run: |
        mkdir package
        pip install -r requirements.txt -t package/
        cd package
        zip -r ../deployment_package.zip .
        cd ..
        zip -g deployment_package.zip lambda_function.py

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v5
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Deploy to Lambda and Publish Version
      run: |
        # Update function code and publish a new version
        # We capture the output to get the Version number
        RESPONSE=$(aws lambda update-function-code --function-name ${{ secrets.AWS_LAMBDA_FUNCTION_NAME }} --zip-file fileb://deployment_package.zip --publish --output json)
        VERSION=$(echo $RESPONSE | jq -r '.Version')
        
        echo "Published Version: $VERSION"
        
        # Sanitize tag name for Alias (AWS Aliases do not allow dots)
        TAG_NAME=${{ github.ref_name }}
        ALIAS_NAME=${TAG_NAME//./-}
        
        echo "Creating/Updating Alias: $ALIAS_NAME pointing to Version: $VERSION"
        
        # Check if alias exists
        if aws lambda get-alias --function-name ${{ secrets.AWS_LAMBDA_FUNCTION_NAME }} --name $ALIAS_NAME >/dev/null 2>&1; then
            aws lambda update-alias --function-name ${{ secrets.AWS_LAMBDA_FUNCTION_NAME }} --name $ALIAS_NAME --function-version $VERSION
        else
            aws lambda create-alias --function-name ${{ secrets.AWS_LAMBDA_FUNCTION_NAME }} --name $ALIAS_NAME --function-version $VERSION
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: deployment_package.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

